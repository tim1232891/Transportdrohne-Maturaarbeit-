{% extends "base.html" %}
{% block content %}

<div class="card">
  <h2>Extraorder bearbeiten</h2>

  <!-- Fehlerbox -->
  <div id="formError" class="alert alert-error" style="display:none;"></div>

  <form id="extraForm" method="post">
    <div class="field">
      <label for="name">Name <span style="color:#ef4444">*</span></label>
      <input type="text" id="name" name="name" value="{{ order['name'] }}">
    </div>

    <div class="field">
      <label for="phone">Telefon</label>
      <input type="text" id="phone" name="phone" value="{{ order['phone'] or '' }}">
    </div>

    <div class="field">
      <label for="notes">Notes</label>
      <textarea id="notes" name="notes">{{ order['notes'] or '' }}</textarea>
    </div>

    <hr style="margin:16px 0; opacity:.3;">

    <h3>Waypoints</h3>
    <p class="muted">Klicken Sie in die Karte, um Punkte zu setzen. Ein Marker ist immer „in der Hand“.</p>

    <!-- Karte -->
    <div id="map" style="height:420px; border-radius:10px; border:1px solid #e5e7eb; margin-bottom:12px;"></div>

    <!-- Tabelle spiegelt die Marker -->
    <table class="table" id="wpTable">
      <thead>
        <tr><th>Latitude</th><th>Longitude</th><th>Aktion</th></tr>
      </thead>
      <tbody>
        {% if waypoints and waypoints|length > 0 %}
          {% for wp in waypoints %}
          <tr>
            <td><input type="text" name="wp_lat" value="{{ wp['lat'] }}"></td>
            <td><input type="text" name="wp_lon" value="{{ wp['lon'] }}"></td>
            <td><button class="btn btn-danger" onclick="return removeRow(this)">−</button></td>
          </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>

    <!-- Nur Utility-Buttons (kein „Neuen setzen“) -->
    <div style="margin:8px 0 16px; display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn btn-secondary" onclick="return fitToMarkers()">Karte auf Punkte zoomen</button>
      <button class="btn btn-secondary" onclick="return clearAll()">Alle Punkte entfernen</button>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn-primary">Speichern</button>
      <a href="{{ url_for('admin') }}" class="btn-secondary">Zurück</a>
    </div>
  </form>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // ===== Karte =====
  const map = L.map('map', { zoomControl: true }).setView([47.3769, 8.5417], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  const tbody = document.querySelector('#wpTable tbody');
  const markers = []; // [{marker, tr}]

  function parseNum(v){ const n = parseFloat(String(v).replace(',', '.')); return isFinite(n) ? n : null; }

  // Marker <-> Row koppeln
  function addMarker(lat, lon){
    const m = L.marker([lat, lon], { draggable: true }).addTo(map);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" name="wp_lat" value="${lat.toFixed(6)}"></td>
      <td><input type="text" name="wp_lon" value="${lon.toFixed(6)}"></td>
      <td><button class="btn btn-danger" onclick="return removeRow(this)">−</button></td>`;
    tbody.appendChild(tr);

    const latInput = tr.querySelector('input[name="wp_lat"]');
    const lonInput = tr.querySelector('input[name="wp_lon"]');

    // Marker -> Inputs
    m.on('dragend', () => {
      const p = m.getLatLng();
      latInput.value = p.lat.toFixed(6);
      lonInput.value = p.lng.toFixed(6);
    });

    // Inputs -> Marker
    function onInputChange(){
      const la = parseNum(latInput.value);
      const lo = parseNum(lonInput.value);
      if (la == null || lo == null) return;
      m.setLatLng([la, lo]);
    }
    latInput.addEventListener('change', onInputChange);
    lonInput.addEventListener('change', onInputChange);

    markers.push({ marker: m, tr });
    return m;
  }

  // ===== Ghost-Marker: immer „in der Hand“ =====
  let placingLocked = false;
  const ghost = L.marker(map.getCenter(), { interactive: false, keyboard: false, opacity: 0.6 }).addTo(map);

  // Ghost folgt der Maus
  map.on('mousemove', (e) => { ghost.setLatLng(e.latlng); });

  // Klick = echten Marker setzen
  map.off('click'); // sicherstellen, dass kein alter Handler aktiv ist
  map.on('click', () => {
    if (placingLocked) return;
    const p = ghost.getLatLng();
    addMarker(p.lat, p.lng);
  });

  // Drag-Schutz (verhindert „Nachzieh-Klicks“)
  map.on('movestart', () => { placingLocked = true; });
  map.on('moveend',   () => { setTimeout(() => placingLocked = false, 100); });

  // Vorhandene Waypoints aus Tabelle übernehmen (Roh-Zeilen ersetzen)
  (function hydrateFromTable(){
    const rows = Array.from(tbody.querySelectorAll('tr'));
    if (!rows.length) return;
    const bounds = L.latLngBounds();
    rows.forEach(tr => {
      const la = parseNum(tr.querySelector('input[name="wp_lat"]').value);
      const lo = parseNum(tr.querySelector('input[name="wp_lon"]').value);
      if (la != null && lo != null) {
        const m = addMarker(la, lo);
        bounds.extend(m.getLatLng());
      }
      tr.remove(); // Roh-Zeile weg, addMarker hat eine neue erzeugt
    });
    if (bounds.isValid()) map.fitBounds(bounds.pad(0.2));
  })();

  // Utility
  function fitToMarkers(){
    const bounds = L.latLngBounds();
    markers.forEach(m => bounds.extend(m.marker.getLatLng()));
    if (bounds.isValid()) map.fitBounds(bounds.pad(0.2));
    return false;
  }
  function clearAll(){
    markers.forEach(({marker,tr}) => { map.removeLayer(marker); tr.remove(); });
    markers.length = 0;
    return false;
  }
  window.removeRow = function(btn){
    const tr = btn.closest('tr');
    const idx = markers.findIndex(x => x.tr === tr);
    if (idx >= 0) { map.removeLayer(markers[idx].marker); markers.splice(idx,1); }
    tr.remove();
    return false;
  };

  // Validierung
  const form = document.getElementById('extraForm');
  const errorBox = document.getElementById('formError');
  form.addEventListener('submit', (e) => {
    errorBox.style.display = 'none';
    errorBox.textContent = '';
    const name = document.getElementById('name').value.trim();
    if (!name) {
      e.preventDefault();
      errorBox.textContent = 'Bitte einen Namen eingeben.';
      errorBox.style.display = 'block';
      document.getElementById('name').focus();
    }
  });
</script>

<style>
  #map { cursor: crosshair; }
  .alert{padding:.75rem 1rem;border-radius:.6rem;margin:.75rem 0}
  .alert-error{background:#fee2e2;border:1px solid #fecaca}
  .field{margin-bottom:12px}
  .field input,.field textarea{width:100%;padding:.55rem .65rem;border:1px solid #cbd5e1;border-radius:.5rem}
  .btn-danger,.btn-secondary{border:1px solid #cbd5e1;border-radius:.6rem;padding:.4rem .7rem}
  .btn-primary{padding:.5rem .9rem;border-radius:.6rem;border:0;background:#0ea5e9;color:#fff}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:.5rem;border-bottom:1px solid #e5e7eb}
</style>

{% endblock %}
