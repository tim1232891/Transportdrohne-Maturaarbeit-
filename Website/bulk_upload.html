{% extends "base.html" %}
{% set active = 'bulk_upload' %}
{% block content %}

<section class="bulk-upload">
  <h2>Auftragsimport</h2>
  <p class="hint">Erwartete Spalten: <code>name, street, zip, city, country, notes</code></p>

  {# Meldungen #}
  {% if error %}
    <div class="alert alert-error">
      {% if error is string %}<div>{{ error }}</div>
      {% else %}{% for line in error %}<div>{{ line }}</div>{% endfor %}{% endif %}
    </div>
  {% endif %}
  {% if success %}
    <div class="alert alert-success">
      {{ count or 0 }} Aufträge importiert{% if skipped_count %}, {{ skipped_count }} übersprungen{% endif %}.
    </div>
  {% endif %}
  {% if missing_columns %}
    <div class="alert alert-warning">Fehlende Spalten: {{ missing_columns|join(', ') }}.</div>
  {% endif %}
  {% if duplicates_count %}
    <div class="alert alert-info">{{ duplicates_count }} potenzielle Duplikate erkannt (übersprungen).</div>
  {% endif %}

  {# Upload-Form #}
  <form method="POST" enctype="multipart/form-data" class="upload-form">
    <div class="dropzone" id="dropzone" onclick="document.getElementById('file').click()">
      <input id="file" name="file" type="file" accept=".xlsx,.xls" required style="display:none" onchange="onFileChosen(this)">
      <p><strong>Datei hier ablegen</strong> oder klicken.</p>
      <small>.xlsx, .xls · bis ~10&nbsp;MB</small>
      <div id="chosenFile" class="filechip" style="display:none;"></div>
    </div>

    <div class="actions">
      <button type="submit" class="btn-primary">Import starten</button>

      {# Nur Excel-Template behalten #}
      <a class="btn-secondary" href="{{ url_for('static', filename='bulk_template.xlsx') }}">Excel-Template herunterladen</a>
    </div>
  </form>

  {# Vorschau (falls Server sie liefert) #}
  {% if preview_rows %}
    <h3>Vorschau ({{ preview_rows|length }} Zeilen)</h3>
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            {% for col in preview_columns or preview_rows[0].keys() %}
              <th>{{ col }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in preview_rows %}
            <tr>
              {% for col in (preview_columns or row.keys()) %}
                <td>{{ row[col] }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
</section>

<style>
  .bulk-upload{max-width:900px}
  .hint{margin:.25rem 0 1rem;color:#475569}
  .alert{padding:.75rem 1rem;border-radius:.6rem;margin:.75rem 0}
  .alert-error{background:#fee2e2;border:1px solid #fecaca}
  .alert-success{background:#dcfce7;border:1px solid #bbf7d0}
  .alert-warning{background:#fef3c7;border:1px solid #fde68a}
  .alert-info{background:#e0f2fe;border:1px solid #bae6fd}

  .dropzone{
    border:2px dashed #cbd5e1;border-radius:.9rem;padding:1.75rem;text-align:center;cursor:pointer;
    transition:background .15s ease,border-color .15s ease
  }
  .dropzone.dragover{background:#f1f5f9;border-color:#94a3b8}
  .filechip{margin-top:.75rem;display:inline-block;padding:.25rem .6rem;border-radius:999px;
            border:1px solid #cbd5e1;background:#f8fafc;font-size:.9rem}

  .actions{display:flex;gap:.6rem;align-items:center;margin-top:1rem;flex-wrap:wrap}
  .btn-primary{padding:.6rem 1rem;border-radius:.6rem;border:0;background:#0ea5e9;color:#fff;text-decoration:none}
  .btn-secondary{padding:.5rem .9rem;border-radius:.6rem;border:1px solid #cbd5e1;background:#fff;color:#0f172a;text-decoration:none}

  .table-wrap{overflow:auto;border:1px solid #e5e7eb;border-radius:.6rem;margin-top:1rem}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:.55rem .6rem;border-bottom:1px solid #e5e7eb;white-space:nowrap}
</style>

<script>
  // Drag&Drop + Dateiname
  const dz = document.getElementById('dropzone');
  const chip = document.getElementById('chosenFile');
  const fileInput = document.getElementById('file');

  function onFileChosen(input){
    if (input.files && input.files[0]) {
      chip.textContent = input.files[0].name;
      chip.style.display = 'inline-block';
    }
  }
  ['dragenter','dragover'].forEach(evt =>
    dz.addEventListener(evt, e => { e.preventDefault(); dz.classList.add('dragover'); })
  );
  ['dragleave','drop'].forEach(evt =>
    dz.addEventListener(evt, e => { e.preventDefault(); dz.classList.remove('dragover'); })
  );
  dz.addEventListener('drop', e => {
    const files = e.dataTransfer.files;
    if (!files || !files.length) return;
    fileInput.files = files;
    onFileChosen(fileInput);
  });
</script>

{% endblock %}
