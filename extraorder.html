{% extends "base.html" %}
{% set active = 'extraorder' %}
{% block content %}

{% if success %}
  <div class="success-box">
    <h3>Auftrag gespeichert</h3>
    <p>Vielen Dank! Ihr Auftrag wurde erfolgreich gesichert.<br>
    Auftragsnummer: <strong>#{{ job_id }}</strong></p>
  </div>

  <!-- Drohnen-Animation -->
  <div id="droneOverlay">
    <img src="{{ url_for('static', filename='assets/drone-icon.png') }}" alt="Drohne" class="drone">
  </div>
{% endif %}


{% if not success %}
  <form method="post">
    <div class="field">
      <label for="name">Name *</label>
      <input type="text" name="name" id="name" required>
    </div>

    <div class="field">
      <label for="phone">Telefon</label>
      <input type="text" name="phone" id="phone">
    </div>

    <div class="field">
      <label for="region">Region / Stadt (optional)</label>
      <div style="display:flex; gap:8px;">
        <input type="text" id="region" placeholder="z. B. Bern oder Meilen" style="flex:1;">
        <button type="button" id="regionBtn" class="btn-secondary">Karte aktualisieren</button>
      </div>
    </div>

    <div class="field">
      <label for="notes">Zusatzinfos</label>
      <textarea name="notes" id="notes"></textarea>
    </div>

    <!-- Waypoint Buttons -->
    <div class="field">
      <label>Waypoints (Klick auf Karte – Marker folgt der Maus)</label>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <!-- "Neuen setzen" entfernt -->
        <button type="button" id="removeLastBtn" class="btn-secondary">Letzten löschen</button>
        <button type="button" id="clearWaypointsBtn" class="btn-secondary">Alle löschen</button>
      </div>
    </div>

    <!-- Karte -->
    <div id="map" style="height: 400px; border-radius: 12px; margin: 20px 0; cursor: crosshair;"></div>

    <!-- Hidden Felder für alle Waypoints -->
    <div id="waypointsContainer"></div>

    <div class="form-actions">
      <button type="submit" class="btn-primary">Auftrag speichern</button>
    </div>
  </form>
{% endif %}

<!-- Leaflet.js -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

{% if not success %}
<script>
  // Karte initialisieren (Zürich)
  var map = L.map('map').setView([47.3769, 8.5417], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
  }).addTo(map);

  var waypoints = [];
  var markers = [];

  // Vorschau-Marker, der der Maus folgt
  var previewMarker = L.marker(map.getCenter(), {
    opacity: 0.6,
    interactive: false,   // ignoriert Maus-Events
    keyboard: false
  }).addTo(map);

  // Marker-Position mit Mausbewegung aktualisieren
  map.on('mousemove', function(e) {
    previewMarker.setLatLng(e.latlng);
  });

  // Klick auf Karte → Waypoint setzen (immer aktiv)
  map.on('click', function(e) {
    var marker = L.marker(e.latlng).addTo(map);
    markers.push(marker);
    waypoints.push({lat: e.latlng.lat, lon: e.latlng.lng});
    updateHiddenInputs();
  });

  // Button: Letzten löschen
  document.getElementById('removeLastBtn').addEventListener('click', function() {
    if (markers.length > 0) {
      var lastMarker = markers.pop();
      map.removeLayer(lastMarker);
      waypoints.pop();
      updateHiddenInputs();
    }
  });

  // Button: Alle löschen
  document.getElementById('clearWaypointsBtn').addEventListener('click', function() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    waypoints = [];
    updateHiddenInputs();
  });

  // Versteckte Input-Felder aktualisieren
  function updateHiddenInputs() {
    var container = document.getElementById('waypointsContainer');
    container.innerHTML = '';
    waypoints.forEach((wp, idx) => {
      container.innerHTML += `<input type="hidden" name="lat_${idx}" value="${wp.lat}">`;
      container.innerHTML += `<input type="hidden" name="lon_${idx}" value="${wp.lon}">`;
    });
    container.innerHTML += `<input type="hidden" name="waypoint_count" value="${waypoints.length}">`;
  }

  // Region suchen (Nominatim)
  document.getElementById('regionBtn').addEventListener('click', function() {
    var region = document.getElementById('region').value;
    if (!region) return;

    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(region)}`)
      .then(res => res.json())
      .then(data => {
        if (data.length > 0) {
          var lat = parseFloat(data[0].lat);
          var lon = parseFloat(data[0].lon);
          map.setView([lat, lon], 13);
          previewMarker.setLatLng([lat, lon]);
        } else {
          alert("Region nicht gefunden. Bitte andere Eingabe versuchen.");
        }
      })
      .catch(err => console.error(err));
  });
</script>
{% endif %}

{% if success %}
<script>
  // Overlay automatisch nach 3,5 Sekunden ausblenden
  setTimeout(() => {
    document.getElementById("droneOverlay").style.display = "none";
  }, 3500);
</script>
{% endif %}

{% endblock %}
